<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyFam - Genetic Engine</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --bg-color: #0f1014;
            --grid-color: rgba(255, 255, 255, 0.03);
            --node-bg: rgba(35, 35, 40, 0.9);
            --node-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --accent-blue: #3b82f6;
            --accent-pink: #ec4899;
            --highlight: #f59e0b;
            --trait-glow: #06b6d4;
            --carrier-glow: #8b5cf6;
            --line-normal: #444;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-strong: rgba(20, 20, 25, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; overflow: hidden; background-color: var(--bg-color);
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px),
                            linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px; font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-color); user-select: none;
        }

        /* --- Views --- */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.3s; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; display: none; }

        /* --- Landing Page --- */
        #landing-view {
            z-index: 2000; background: var(--bg-color); display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .landing-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        .app-title {
            font-size: 3rem; font-weight: 800; background: linear-gradient(to right, #3b82f6, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 10px;
        }
        .new-project-card {
            background: var(--glass); border: 1px solid var(--glass-border); padding: 20px;
            border-radius: 16px; display: flex; gap: 10px;
        }
        .project-input {
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px;
            border-radius: 8px; color: white; font-size: 1rem; outline: none;
        }
        .btn-primary {
            background: var(--accent-blue); color: white; border: none; padding: 0 20px; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: transform 0.1s; white-space: nowrap;
        }
        .btn-primary:hover { filter: brightness(1.1); }
        .projects-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .project-item {
            background: var(--node-bg); border: 1px solid var(--glass-border); padding: 15px 20px;
            border-radius: 12px; display: flex; align-items: center; justify-content: space-between; transition: border-color 0.2s;
        }
        .btn-icon { background: transparent; border: none; color: #666; cursor: pointer; font-size: 1.2rem; padding: 8px; border-radius: 6px; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-icon.danger:hover { background: rgba(255, 50, 50, 0.2); color: #ff4444; }

        /* --- Trait Ribbon --- */
        .trait-ribbon {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(15, 15, 20, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
            z-index: 900; display: flex; align-items: center; padding: 0 20px 0 160px;
            gap: 10px; overflow-x: auto;
        }
        .ribbon-label { font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-right: 10px; }
        .trait-filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #aaa;
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .trait-filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .trait-filter-btn.active {
            background: rgba(6, 182, 212, 0.2); border-color: var(--trait-glow); color: var(--trait-glow);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2);
        }

        /* --- Tools & Zoom --- */
        .ui-layer { position: absolute; top: 80px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; pointer-events: none; }
        .tool-panel {
            background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(12px); padding: 15px;
            border-radius: 16px; border: 1px solid var(--node-border); pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; gap: 10px; align-items: center;
        }
        .logo-small { font-weight: 800; font-size: 1.2rem; margin-right: 10px; background: linear-gradient(to right, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .draggable-source {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: grab; transition: transform 0.2s; border: 2px solid transparent; font-size: 1.2rem;
        }
        .draggable-source:active { cursor: grabbing; transform: scale(0.9); }
        .source-male { background: rgba(59, 130, 246, 0.2); border-color: var(--accent-blue); color: var(--accent-blue); }
        .source-female { background: rgba(236, 72, 153, 0.2); border-color: var(--accent-pink); color: var(--accent-pink); }
        .nav-btn { background: transparent; border: 1px solid var(--glass-border); color: #aaa; padding: 6px 10px; border-radius: 8px; cursor: pointer; }

        .zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000; pointer-events: auto; }
        .zoom-btn {
            background: rgba(30, 30, 35, 0.9); border: 1px solid var(--node-border); color: white; width: 40px; height: 40px;
            border-radius: 12px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); transition: background 0.2s;
        }
        .zoom-btn:hover { background: #333; }

        /* --- Canvas --- */
        #app-container { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: default; }
        #world { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: visible; }
        
        /* Lines */
        .connection-line { fill: none; stroke: var(--line-normal); stroke-width: 2px; transition: stroke 0.3s; }
        .partner-line { fill: none; stroke: #777; stroke-width: 3px; }
        .sibling-line { fill: none; stroke: var(--line-normal); stroke-width: 2px; stroke-dasharray: 4, 6; stroke-linecap: round; }
        
        .highlighted-conn { stroke: var(--highlight) !important; stroke-width: 3px !important; z-index: 100; }
        
        /* Glowing Genetic Path */
        .trait-path {
            fill: none; stroke: var(--trait-glow); stroke-width: 4px; stroke-linecap: round;
            filter: drop-shadow(0 0 5px var(--trait-glow)); opacity: 0.8; animation: flowDash 30s linear infinite; stroke-dasharray: 10, 5;
        }
        @keyframes flowDash { to { stroke-dashoffset: -1000; } }

        /* --- Nodes --- */
        .node {
            position: absolute; width: auto; min-width: 140px; max-width: 280px; height: auto; min-height: 60px;
            padding: 10px 25px; background: var(--node-bg); backdrop-filter: blur(8px);
            border: 1px solid var(--node-border); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: grab; z-index: 10;
            transition: box-shadow 0.2s, border-color 0.2s; transform-origin: center; flex-direction: column; gap: 5px;
        }
        .node:hover { box-shadow: 0 0 20px rgba(0,0,0,0.6); border-color: #777; z-index: 20; }
        .node.selected { border-color: var(--highlight); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3), 0 10px 40px rgba(0,0,0,0.8); }
        .node.gender-male { border-left: 4px solid var(--accent-blue); }
        .node.gender-female { border-left: 4px solid var(--accent-pink); }
        
        /* Trait Active / Carrier Styles */
        .node.trait-active {
            border-color: var(--trait-glow);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.4), 0 0 30px rgba(6, 182, 212, 0.4);
        }
        .node.trait-carrier {
            border-color: var(--carrier-glow);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.4);
        }
        .node.trait-carrier::after {
            content: 'CARRIER'; position: absolute; top: -18px; right: 0; background: var(--carrier-glow);
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold;
        }

        .node-name { font-weight: 600; font-size: 0.95rem; pointer-events: none; white-space: normal; text-align: center; }
        .node input { width: 100%; background: transparent; border: none; color: white; text-align: center; font-weight: 600; font-size: 0.95rem; outline: none; border-bottom: 1px solid var(--highlight); }
        
        .delete-btn {
            position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; background: #ef4444; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            line-height: 1; padding-bottom: 2px; cursor: pointer; opacity: 0; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 50;
        }
        .node:hover .delete-btn { opacity: 1; }

        .notes-btn {
            position: absolute; left: 5px; top: 5px; width: 20px; height: 20px;
            border-radius: 50%; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center;
            justify-content: center; font-size: 0.8rem; cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .node:hover .notes-btn { opacity: 1; }
        .notes-btn:hover { background: rgba(255, 255, 255, 0.3); color: white; }
        
        .link-handle {
            position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px;
            background-color: #10b981; border-radius: 50%; border: 2px solid var(--bg-color); cursor: crosshair; opacity: 0; transition: opacity 0.2s;
        }
        .node:hover .link-handle { opacity: 1; }
        
        .relation-tag {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: var(--highlight); color: #000;
            font-size: 0.75rem; font-weight: 800; padding: 2px 8px; border-radius: 10px; opacity: 0;
            transition: 0.3s; white-space: nowrap; pointer-events: none; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 100;
        }
        .node.show-relation .relation-tag { opacity: 1; top: -30px; }

        /* Snapping Guides */
        .snap-guide { position: absolute; border-color: var(--highlight); opacity: 0; pointer-events: none; z-index: 5; }
        .snap-guide.horizontal { height: 0; width: 20000px; left: -10000px; border-top: 1px dashed var(--highlight); }
        .snap-guide.vertical { width: 0; height: 20000px; top: -10000px; border-left: 1px dashed var(--highlight); }
        .snap-guide.active { opacity: 0.6; }

        /* --- Side Panel (Genetic Engine) --- */
        .side-panel {
            position: fixed; top: 0; right: -420px; width: 400px; height: 100vh;
            background: var(--glass-strong); backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border); z-index: 3000;
            transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        .side-panel.open { right: 0; }
        
        .panel-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .panel-title h2 { margin: 0; font-size: 1.4rem; color: white; }
        .panel-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .panel-close:hover { color: white; transform: scale(1.1); }

        .panel-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        .input-group { margin-bottom: 10px; }
        .input-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .form-select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white;
            padding: 8px; border-radius: 6px; outline: none; font-size: 0.9rem;
        }
        .form-select:focus { border-color: var(--accent-blue); }
        
        .height-inputs { display: flex; gap: 10px; }

        /* Prediction Viz */
        .prediction-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; margin-top: 10px;
        }
        .pred-header { font-size: 0.8rem; color: var(--trait-glow); text-transform: uppercase; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .pred-bar-container { position: relative; height: 24px; background: rgba(0,0,0,0.5); border-radius: 12px; overflow: hidden; margin-bottom: 5px; }
        .pred-bar-fill { height: 100%; background: linear-gradient(90deg, #444, #666); width: 0%; transition: width 0.5s; }
        .pred-marker { position: absolute; top: 0; width: 2px; height: 100%; background: var(--trait-glow); box-shadow: 0 0 5px var(--trait-glow); }
        .pred-badge {
            display: inline-block; background: rgba(16, 185, 129, 0.2); color: #10b981;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-top: 5px; margin-right: 5px;
        }
        .pred-badge.outlier { background: rgba(245, 158, 11, 0.2); color: var(--highlight); }
        
        .pred-trait-block { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .pred-trait-title { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        .pred-trait-actual { font-weight: 600; color: white; font-size: 0.95rem; margin-bottom: 2px; }
        .pred-trait-list { font-size: 0.8rem; color: #888; line-height: 1.4; }
        .trait-match { color: #10b981; }
        .trait-diff { color: var(--highlight); }

        .bio-area {
            width: 100%; min-height: 100px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: white; padding: 10px; border-radius: 8px; resize: vertical; outline: none; font-family: 'Inter', sans-serif; font-size: 0.9rem;
        }
        .bio-area:focus { border-color: var(--accent-blue); }

    </style>
</head>
<body>

    <!-- Landing Page -->
    <div id="landing-view" class="view-section">
        <div class="landing-container">
            <div class="app-title">EasyFam</div>
            <div class="new-project-card">
                <input type="text" id="newProjectName" class="project-input" placeholder="Enter Family Name" onkeypress="handleEnter(event)">
                <button class="btn-primary" onclick="createNewProject()">Create Project</button>
            </div>
            <h3 style="margin-top:20px; color:#888; font-weight:400;">Your Projects</h3>
            <div id="projectsList" class="projects-list"></div>
        </div>
    </div>

    <!-- Workspace View -->
    <div id="workspace-view" class="view-section hidden">
        <!-- Top Ribbon -->
        <div class="trait-ribbon" id="traitRibbon">
            <span class="ribbon-label">Genetic Engine:</span>
            <!-- Traits injected here -->
        </div>

        <div class="ui-layer">
            <div class="tool-panel">
                <button class="nav-btn" onclick="saveAndClose()">‚Üê Projects</button>
                <div class="logo-small" id="workspaceTitle">Family</div>
                <div class="draggable-source source-male" draggable="true" ondragstart="startSpawnDrag(event, 'male')">M</div>
                <div class="draggable-source source-female" draggable="true" ondragstart="startSpawnDrag(event, 'female')">F</div>
            </div>
        </div>

        <div class="zoom-controls">
            <button class="zoom-btn" onclick="adjustZoom(-0.1)">-</button>
            <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
        </div>

        <!-- Slide-In Side Panel -->
        <div id="sidePanel" class="side-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <h2 id="panelName">Name</h2>
                    <span id="panelRelation" style="font-size: 0.8rem; color: var(--highlight);"></span>
                </div>
                <button class="panel-close" onclick="closeSidePanel()">√ó</button>
            </div>
            <div class="panel-content">
                
                <!-- Traits Section -->
                <div class="input-group">
                    <label class="input-label">Hair Type</label>
                    <select id="selectHair" class="form-select" onchange="updateNodeData()">
                        <option value="">Unknown</option>
                        <option value="Straight Hair">Straight</option>
                        <option value="Wavy Hair">Wavy</option>
                        <option value="Curly Hair">Curly</option>
                        <option value="Coily Hair">Coily</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Eye Color</label>
                    <select id="selectEyes" class="form-select" onchange="updateNodeData()">
                        <option value="">Unknown</option>
                        <option value="Brown Eyes">Brown</option>
                        <option value="Blue Eyes">Blue</option>
                        <option value="Green Eyes">Green</option>
                        <option value="Hazel Eyes">Hazel</option>
                    </select>
                </div>

                <!-- Height Section -->
                <div class="input-group">
                    <label class="input-label">Height (Actual)</label>
                    <div class="height-inputs">
                        <select id="selectFt" class="form-select" onchange="updateNodeData()">
                            <option value="">Ft</option>
                            <option value="4">4'</option><option value="5">5'</option><option value="6">6'</option><option value="7">7'</option>
                        </select>
                        <select id="selectIn" class="form-select" onchange="updateNodeData()">
                            <option value="">In</option>
                            <!-- 0-11 filled by JS -->
                        </select>
                    </div>
                </div>

                <!-- Genetic Prediction Engine UI -->
                <div class="prediction-card" id="predEngine">
                    <div class="pred-header">
                        <span>Genetic Forecast</span>
                        <i class="ph ph-dna"></i>
                    </div>
                    
                    <!-- Hair Forecast -->
                    <div class="pred-trait-block">
                        <div class="pred-trait-title">Hair Forecast</div>
                        <div id="fcHairAct" class="pred-trait-actual">--</div>
                        <div id="fcHairPred" class="pred-trait-list">--</div>
                    </div>

                    <!-- Eye Forecast -->
                    <div class="pred-trait-block">
                        <div class="pred-trait-title">Eye Forecast</div>
                        <div id="fcEyeAct" class="pred-trait-actual">--</div>
                        <div id="fcEyePred" class="pred-trait-list">--</div>
                    </div>

                    <div style="font-size:0.8rem; color:#ccc; margin-bottom:5px;">Height Potential</div>
                    <div class="pred-bar-container">
                        <div class="pred-bar-fill" id="predActualBar"></div> <!-- Actual -->
                        <div class="pred-marker" id="predEstMarker"></div> <!-- Estimated -->
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#888;">
                        <span id="txtActual">Act: --</span>
                        <span id="txtEst">Pred: --</span>
                    </div>
                    <div id="predBadges"></div>
                </div>

                <!-- Bio / Notes -->
                <div class="input-group" style="margin-top: 20px;">
                    <label class="input-label">Biography & Notes</label>
                    <textarea id="inputBio" class="bio-area" placeholder="Write history, stories, or facts..." onchange="updateNodeData()"></textarea>
                </div>

                <div style="margin-top:auto; text-align:center;">
                    <button class="btn-primary" style="background:#ef4444; width:100%;" onclick="deleteCurrentNode()">Remove Person</button>
                </div>
            </div>
        </div>

        <div id="app-container">
            <div id="world">
                <div id="snap-guide-h" class="snap-guide horizontal"></div>
                <div id="snap-guide-v" class="snap-guide vertical"></div>
                <svg id="trait-path-layer"></svg> 
                <svg id="sibling-layer"></svg>
                <svg id="connections-layer"></svg>
                <svg id="temp-line-layer" style="z-index: 5;">
                    <path id="temp-line" stroke="#10b981" stroke-width="2" fill="none" stroke-dasharray="5,5" style="display:none;"></path>
                </svg>
                <div id="nodes-layer"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Initialization ---
        const inchesSel = document.getElementById('selectIn');
        for(let i=0; i<12; i++) {
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = i + '"';
            inchesSel.appendChild(opt);
        }

        // --- State ---
        let currentProjectId = null;
        let projects = JSON.parse(localStorage.getItem('easyfam_projects')) || {};
        let nodes = [];
        let connections = []; 
        let selectedNodeId = null;
        let activeTraitFilter = null; 
        
        let isLinking = false; 
        let linkSourceId = null;

        function saveToStorage() { localStorage.setItem('easyfam_projects', JSON.stringify(projects)); }

        // --- Core UI Logic ---
        function initLanding() {
            document.getElementById('landing-view').classList.remove('hidden');
            document.getElementById('workspace-view').classList.add('hidden');
            document.getElementById('landing-view').style.display = 'flex';
            renderProjectsList();
        }

        function renderProjectsList() {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            const sortedIds = Object.keys(projects).sort((a,b) => projects[b].lastModified - projects[a].lastModified);
            if (sortedIds.length === 0) { list.innerHTML = `<div style="text-align:center; color:#444; padding:20px;">No projects yet.</div>`; return; }
            sortedIds.forEach(id => {
                const p = projects[id];
                const date = new Date(p.lastModified).toLocaleDateString();
                const div = document.createElement('div');
                div.className = 'project-item';
                div.innerHTML = `
                    <div class="project-info"><h3>${p.name}</h3><span>${p.nodes.length} Members ‚Ä¢ ${date}</span></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-primary" style="padding: 6px 12px; font-size: 0.9rem;" onclick="loadProject('${id}')">Open</button>
                        <button class="btn-icon danger" onclick="deleteProject('${id}')">üóë</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function createNewProject() {
            const input = document.getElementById('newProjectName');
            const name = input.value.trim();
            if(!name) return;
            const id = 'proj_' + Date.now();
            projects[id] = { id: id, name: name, lastModified: Date.now(), nodes: [], connections: [] };
            saveToStorage(); input.value = ''; loadProject(id);
        }

        function deleteProject(id) {
            if(confirm('Delete project?')) { delete projects[id]; saveToStorage(); renderProjectsList(); }
        }

        function loadProject(id) {
            currentProjectId = id;
            const p = projects[id];
            nodes = p.nodes || [];
            connections = p.connections || [];
            
            nodes.forEach(n => {
                if(!n.traits) n.traits = { hair: "", eyes: "" };
                if(!n.heightFt) n.heightFt = "";
                if(!n.heightIn) n.heightIn = "";
                if(!n.bio) n.bio = "";
            });

            document.getElementById('workspaceTitle').innerText = p.name;
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('landing-view').style.display = 'none';
            document.getElementById('workspace-view').classList.remove('hidden');
            
            zoom = 1; pan = { x: 0, y: 0 }; updateTransform();
            
            document.getElementById('nodes-layer').innerHTML = ''; 
            nodes.forEach(n => renderNodeDOM(n));
            setTimeout(() => { renderConnections(); renderTraitRibbon(); }, 0);
        }

        function saveAndClose() {
            if(currentProjectId) {
                projects[currentProjectId].nodes = nodes;
                projects[currentProjectId].connections = connections;
                projects[currentProjectId].lastModified = Date.now();
                saveToStorage();
            }
            currentProjectId = null; initLanding();
        }

        function autoSave() {
            if(currentProjectId && projects[currentProjectId]) {
                projects[currentProjectId].nodes = nodes;
                projects[currentProjectId].connections = connections;
                projects[currentProjectId].lastModified = Date.now();
                saveToStorage();
                renderTraitRibbon(); 
            }
        }

        // --- Canvas ---
        let zoom = 1; let pan = { x: 0, y: 0 };
        const container = document.getElementById('app-container');
        const world = document.getElementById('world');
        function updateTransform() { world.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`; }
        function adjustZoom(delta) { zoom = Math.min(Math.max(zoom + delta, 0.2), 3); updateTransform(); }
        container.addEventListener('wheel', (e) => { e.preventDefault(); adjustZoom(e.deltaY > 0 ? -0.1 : 0.1); }, { passive: false });
        
        let isPanning = false; let panStart = {};
        container.addEventListener('mousedown', (e) => {
            if (e.target === container || e.target.tagName === 'svg' || e.target === world) {
                isPanning = true; panStart = { x: e.clientX - pan.x, y: e.clientY - pan.y }; container.style.cursor = 'grabbing';
                closeSidePanel();
            }
        });

        // --- Linking Functions ---
        function startLinking(e, id) { 
            e.stopPropagation(); 
            isLinking = true; 
            linkSourceId = id; 
            document.getElementById('temp-line').style.display = 'block'; 
        }
        
        function updateTempLine(e) {
            const s = nodes.find(n => n.id === linkSourceId);
            if(!s) return;
            const el = document.getElementById(s.id);
            if(!el) return;
            const sx = s.x + el.offsetWidth/2; 
            const sy = s.y + el.offsetHeight;
            const m = { x: (e.clientX - pan.x)/zoom, y: (e.clientY - pan.y)/zoom };
            const d = `M ${sx} ${sy} C ${sx} ${sy+50}, ${m.x} ${m.y-50}, ${m.x} ${m.y}`;
            document.getElementById('temp-line').setAttribute('d', d);
        }
        
        function finishLinking(targetId) {
            if(!isLinking || linkSourceId === targetId) return;
            if(!connections.some(c => c.parentId === linkSourceId && c.childId === targetId)) {
                connections.push({ parentId: linkSourceId, childId: targetId });
                renderConnections(); 
                if(selectedNodeId) calculateRelations(selectedNodeId);
                autoSave();
            }
            isLinking = false; 
            document.getElementById('temp-line').style.display = 'none';
        }

        // --- Node Logic ---
        function createNode(x, y, gender) {
            const id = 'n-' + Date.now();
            const nodeData = { 
                id, x: x - 70, y: y - 30, name: "Name", gender: gender,
                heightFt: "", heightIn: "", traits: { hair: "", eyes: "" }, bio: ""
            };
            nodes.push(nodeData);
            renderNodeDOM(nodeData);
            selectNode(id);
            autoSave();
        }

        function renderNodeDOM(data) {
            const el = document.createElement('div');
            el.className = `node gender-${data.gender}`;
            el.id = data.id;
            el.style.left = data.x + 'px'; el.style.top = data.y + 'px';
            el.innerHTML = `
                <div class="node-name">${data.name}</div>
                <div class="relation-tag"></div><div class="link-handle"></div>
                <div class="notes-btn"><i class="ph ph-list"></i></div>
                <div class="delete-btn" title="Remove">√ó</div>
            `;
            
            // Isolate click listeners
            const delBtn = el.querySelector('.delete-btn');
            delBtn.addEventListener('mousedown', (e) => {
                e.stopPropagation(); // Stop drag
                deleteNode(data.id); 
            });

            const notesBtn = el.querySelector('.notes-btn');
            notesBtn.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                openSidePanel(data.id);
            });

            const linkBtn = el.querySelector('.link-handle');
            linkBtn.addEventListener('mousedown', (e) => {
                startLinking(e, data.id);
            });

            el.addEventListener('mousedown', (e) => {
                // If not stopped by children above
                if (e.target.tagName !== 'INPUT' && !e.target.classList.contains('delete-btn') && !e.target.closest('.notes-btn') && !e.target.classList.contains('link-handle')) { 
                    startDragNode(e, data.id); 
                    selectNode(data.id);
                }
            });
            el.addEventListener('dblclick', () => editName(data.id));
            el.addEventListener('mouseup', () => { if(isLinking) finishLinking(data.id); });
            document.getElementById('nodes-layer').appendChild(el);
            updateTraitVisuals();
        }

        function deleteNode(id) {
            if(!confirm("Are you sure? This will remove connections too.")) return;
            const el = document.getElementById(id);
            if(el) el.remove();
            nodes = nodes.filter(n => n.id !== id);
            connections = connections.filter(c => c.parentId !== id && c.childId !== id);
            if(selectedNodeId === id) { selectedNodeId = null; closeSidePanel(); }
            renderConnections(); 
            renderTraitRibbon();
            drawTraitPath(activeTraitFilter);
            autoSave();
        }

        let isDraggingNode = false; let dragNodeId = null; let dragStartMouse = {}; let dragStartNodePos = {};
        function startDragNode(e, id) {
            e.stopPropagation(); isDraggingNode = true; dragNodeId = id;
            const node = nodes.find(n => n.id === id);
            dragStartMouse = { x: e.clientX, y: e.clientY }; dragStartNodePos = { x: node.x, y: node.y };
        }
        
        window.addEventListener('mousemove', (e) => {
            if (isPanning) { pan.x = e.clientX - panStart.x; pan.y = e.clientY - panStart.y; updateTransform(); return; }
            if (isDraggingNode && dragNodeId) {
                const node = nodes.find(n => n.id === dragNodeId);
                const dx = (e.clientX - dragStartMouse.x) / zoom;
                const dy = (e.clientY - dragStartMouse.y) / zoom;
                let newX = dragStartNodePos.x + dx;
                let newY = dragStartNodePos.y + dy;

                const SNAP = 15; let snapY = false, snapX = false;
                const hGuide = document.getElementById('snap-guide-h');
                const vGuide = document.getElementById('snap-guide-v');

                for (let other of nodes) {
                    if (other.id === dragNodeId) continue;
                    if (Math.abs(newY - other.y) < SNAP) { 
                        newY = other.y; snapY = true; hGuide.style.top = (newY+30)+'px'; hGuide.classList.add('active'); 
                    }
                    if (Math.abs(newX - other.x) < SNAP) { 
                        newX = other.x; snapX = true; vGuide.style.left = newX+'px'; vGuide.classList.add('active'); 
                    }
                }
                if(!snapY) hGuide.classList.remove('active');
                if(!snapX) vGuide.classList.remove('active');

                node.x = newX; node.y = newY;
                const el = document.getElementById(dragNodeId);
                el.style.left = node.x + 'px'; el.style.top = node.y + 'px';
                
                renderConnections();
                if(activeTraitFilter) requestAnimationFrame(() => drawTraitPath(activeTraitFilter));
            }
            if(isLinking) updateTempLine(e);
        });
        window.addEventListener('mouseup', () => {
            isPanning = false; container.style.cursor = 'default';
            if(isDraggingNode) { 
                isDraggingNode = false; dragNodeId = null; 
                document.getElementById('snap-guide-h').classList.remove('active');
                document.getElementById('snap-guide-v').classList.remove('active');
                autoSave(); 
            }
            if(isLinking) { isLinking = false; document.getElementById('temp-line').style.display = 'none'; }
        });

        // --- Side Panel & Prediction ---
        const sidePanel = document.getElementById('sidePanel');
        let currentPanelId = null;

        function openSidePanel(id) {
            currentPanelId = id;
            const node = nodes.find(n => n.id === id);
            
            // Populate fields
            document.getElementById('panelName').innerText = node.name;
            document.getElementById('selectHair').value = node.traits.hair || "";
            document.getElementById('selectEyes').value = node.traits.eyes || "";
            document.getElementById('selectFt').value = node.heightFt || "";
            document.getElementById('selectIn').value = node.heightIn || "";
            document.getElementById('inputBio').value = node.bio || "";
            
            // Force reset of UI
            document.getElementById('txtActual').innerText = "--"; 
            document.getElementById('txtEst').innerText = "--";
            
            runGeneticPrediction(node);
            sidePanel.classList.add('open');
        }

        function closeSidePanel() { sidePanel.classList.remove('open'); currentPanelId = null; }

        function updateNodeData() {
            if(!currentPanelId) return;
            const node = nodes.find(n => n.id === currentPanelId);
            node.traits.hair = document.getElementById('selectHair').value;
            node.traits.eyes = document.getElementById('selectEyes').value;
            node.heightFt = document.getElementById('selectFt').value;
            node.heightIn = document.getElementById('selectIn').value;
            node.bio = document.getElementById('inputBio').value;
            
            runGeneticPrediction(node);
            renderTraitRibbon();
            updateTraitVisuals();
            autoSave();
        }
        
        function deleteCurrentNode() { if(currentPanelId) deleteNode(currentPanelId); }

        function runGeneticPrediction(node) {
            // Get all ancestors
            const ancestors = getAncestors(node.id).map(a => nodes.find(n => n.id === a.id)).filter(n => n);
            
            // --- 1. Full Trait Forecasts ---
            function predictTrait(traitKey, displayIdAct, displayIdPred) {
                const actual = node.traits[traitKey];
                const actEl = document.getElementById(displayIdAct);
                const predEl = document.getElementById(displayIdPred);
                
                actEl.innerText = actual || "--";
                actEl.className = 'pred-trait-actual';

                if (ancestors.length === 0) {
                    predEl.innerText = "No Data";
                    return;
                }

                // Count all
                const counts = {};
                let total = 0;
                ancestors.forEach(p => {
                    const t = p.traits[traitKey];
                    if(t) {
                        counts[t] = (counts[t] || 0) + 1;
                        total++;
                    }
                });
                
                if (total === 0) {
                    predEl.innerText = "No Data";
                    return;
                }

                // Sort by frequency
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                
                // Build string
                const predStr = sorted.map(([t, c]) => `${t} (${Math.round(c/total*100)}%)`).join(', ');
                predEl.innerText = predStr;

                if (actual && sorted.length > 0) {
                    const top = sorted[0][0];
                    if(actual === top) actEl.classList.add('trait-match');
                    else actEl.classList.add('trait-diff');
                }
            }

            predictTrait('hair', 'fcHairAct', 'fcHairPred');
            predictTrait('eyes', 'fcEyeAct', 'fcEyePred');

            // --- 2. Weighted Height Prediction (80/15/5) ---
            const badgesDiv = document.getElementById('predBadges');
            const txtAct = document.getElementById('txtActual');
            const txtEst = document.getElementById('txtEst');
            const barAct = document.getElementById('predActualBar');
            const markEst = document.getElementById('predEstMarker');
            
            badgesDiv.innerHTML = '';
            
            // Parents
            const parents = connections.filter(c => c.childId === node.id).map(c => nodes.find(n => n.id === c.parentId));
            
            // Grandparents (Parents of parents)
            let grandparents = [];
            parents.forEach(p => {
                const gps = connections.filter(c => c.childId === p.id).map(c => nodes.find(n => n.id === c.parentId));
                grandparents = [...grandparents, ...gps];
            });

            // Normalizer Helper: Convert all heights to target gender equivalent
            function getNormalizedHeight(p) {
                if(!p.heightFt) return null;
                let h = (parseInt(p.heightFt)*12) + parseInt(p.heightIn || 0);
                if(node.gender === 'male' && p.gender === 'female') h += 5;
                if(node.gender === 'female' && p.gender === 'male') h -= 5;
                return h;
            }

            // Calc Averages
            const parentHeights = parents.map(getNormalizedHeight).filter(h => h !== null);
            const gpHeights = grandparents.map(getNormalizedHeight).filter(h => h !== null);
            
            const avgP = parentHeights.length ? parentHeights.reduce((a,b)=>a+b,0)/parentHeights.length : null;
            const avgGP = gpHeights.length ? gpHeights.reduce((a,b)=>a+b,0)/gpHeights.length : null;
            const popMean = 67; // Standard

            // Logic: 80% Parents, 15% GPs, 5% Mean.
            // If GPs missing -> 95% Parents, 5% Mean.
            // If Parents missing -> Cannot predict.
            
            let predIn = null;

            if (avgP !== null) {
                if (avgGP !== null) {
                    predIn = (avgP * 0.80) + (avgGP * 0.15) + (popMean * 0.05);
                } else {
                    predIn = (avgP * 0.95) + (popMean * 0.05);
                }
            }

            // Display Logic
            if (node.heightFt && node.heightIn) {
                const myInches = (parseInt(node.heightFt) * 12) + parseInt(node.heightIn);
                txtAct.innerText = `Act: ${node.heightFt}'${node.heightIn}"`;
                const pct = Math.min(Math.max((myInches - 48) / 36 * 100, 0), 100);
                barAct.style.width = pct + "%";

                if (predIn !== null) {
                    const pFt = Math.floor(predIn / 12);
                    const pIn = Math.round(predIn % 12);
                    txtEst.innerText = `Pred: ${pFt}'${pIn}"`;
                    
                    const predPct = Math.min(Math.max((predIn - 48) / 36 * 100, 0), 100);
                    markEst.style.left = predPct + "%";
                    markEst.style.display = 'block';

                    const diff = myInches - predIn;
                    
                    if (Math.abs(diff) <= 1) {
                        const b = document.createElement('span');
                        b.className = 'pred-badge';
                        b.style.color = '#10b981';
                        b.style.background = 'rgba(16, 185, 129, 0.2)';
                        b.innerText = "Genetic Match";
                        badgesDiv.appendChild(b);
                    } else if (diff >= 2) {
                        const b = document.createElement('span');
                        b.className = 'pred-badge outlier';
                        b.innerText = "Growth Spurt Outlier";
                        badgesDiv.appendChild(b);
                    }

                } else {
                    txtEst.innerText = "Pred: Need Parents";
                    markEst.style.display = 'none';
                }
            } else {
                txtAct.innerText = "Act: --";
                barAct.style.width = "0%";
                markEst.style.display = 'none';
            }
        }

        // --- Trait Visuals ---
        function renderTraitRibbon() {
            const ribbon = document.getElementById('traitRibbon');
            ribbon.innerHTML = '<span class="ribbon-label">Genetic Engine:</span>';
            const allTraits = new Set();
            nodes.forEach(n => {
                if(n.traits.hair) allTraits.add(n.traits.hair);
                if(n.traits.eyes) allTraits.add(n.traits.eyes);
            });
            allTraits.forEach(trait => {
                const btn = document.createElement('button');
                btn.className = `trait-filter-btn ${activeTraitFilter === trait ? 'active' : ''}`;
                btn.innerText = trait;
                btn.onclick = () => toggleTraitFilter(trait);
                ribbon.appendChild(btn);
            });
        }

        function toggleTraitFilter(trait) {
            activeTraitFilter = (activeTraitFilter === trait) ? null : trait;
            renderTraitRibbon();
            updateTraitVisuals();
        }

        function updateTraitVisuals() {
            nodes.forEach(n => document.getElementById(n.id)?.classList.remove('trait-active', 'trait-carrier'));
            document.getElementById('trait-path-layer').innerHTML = '';

            if (!activeTraitFilter) return;

            const positives = nodes.filter(n => n.traits.hair === activeTraitFilter || n.traits.eyes === activeTraitFilter);
            positives.forEach(n => document.getElementById(n.id).classList.add('trait-active'));

            positives.forEach(dest => {
                const q = [[dest.id, []]];
                const visited = new Set();
                while(q.length > 0) {
                    const [currId, path] = q.shift();
                    visited.add(currId);
                    
                    if (currId !== dest.id && nodes.find(n=>n.id===currId && (n.traits.hair === activeTraitFilter || n.traits.eyes === activeTraitFilter))) {
                        drawPath(path, currId, dest.id);
                        path.forEach(pid => {
                            const pNode = nodes.find(n=>n.id===pid);
                            const hasTrait = (pNode.traits.hair === activeTraitFilter || pNode.traits.eyes === activeTraitFilter);
                            if(!hasTrait) document.getElementById(pid).classList.add('trait-carrier');
                        });
                    }
                    const parents = connections.filter(c => c.childId === currId).map(c => c.parentId);
                    parents.forEach(pid => q.push([pid, [...path, currId]]));
                }
            });
        }

        function drawPath(pathIds, startNodeId, endNodeId) {
            const fullPath = [startNodeId, ...pathIds.reverse()];
            for(let i=0; i<fullPath.length-1; i++) {
                const p1 = nodes.find(n=>n.id===fullPath[i]);
                const p2 = nodes.find(n=>n.id===fullPath[i+1]);
                const d1 = getNodeDims(p1.id); const d2 = getNodeDims(p2.id);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.setAttribute('class', 'trait-path');
                const sx = d1.x + d1.w/2; const sy = d1.y + d1.h;
                const ex = d2.x + d2.w/2; const ey = d2.y;
                const c1y = sy + 50; const c2y = ey - 50;
                line.setAttribute('d', `M ${sx} ${sy} C ${sx} ${c1y}, ${ex} ${c2y}, ${ex} ${ey}`);
                document.getElementById('trait-path-layer').appendChild(line);
            }
        }
        function drawTraitPath(trait) { if(trait) updateTraitVisuals(); }

        // --- Standard Connections ---
        function renderConnections() {
            const cLayer = document.getElementById('connections-layer');
            const sLayer = document.getElementById('sibling-layer');
            cLayer.innerHTML = ''; sLayer.innerHTML = '';
            
            const childParents = {}; const parentChildren = {};
            connections.forEach(c => {
                if(!childParents[c.childId]) childParents[c.childId] = []; childParents[c.childId].push(c.parentId);
                if(!parentChildren[c.parentId]) parentChildren[c.parentId] = []; parentChildren[c.parentId].push(c.childId);
            });

            // Sibling Lines
            Object.values(parentChildren).forEach(kids => {
                if(kids.length < 2) return;
                const kNodes = kids.map(id => ({id, ...getNodeDims(id)})).sort((a,b) => a.x - b.x);
                for(let i=0; i<kNodes.length-1; i++) {
                    const c1 = kNodes[i]; const c2 = kNodes[i+1];
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    line.setAttribute('class', 'sibling-line');
                    if(isHighlighted(c1.id) || isHighlighted(c2.id)) line.classList.add('highlighted-conn');
                    const sx = c1.x + c1.w; const sy = c1.y + c1.h/2;
                    const ex = c2.x; const ey = c2.y + c2.h/2;
                    const mx = (sx + ex) / 2;
                    line.setAttribute('d', `M ${sx} ${sy} C ${mx} ${sy}, ${mx} ${ey}, ${ex} ${ey}`);
                    sLayer.appendChild(line);
                }
            });

            // Parent-Child
            Object.entries(childParents).forEach(([cid, pids]) => {
                const child = {id:cid, ...getNodeDims(cid)};
                if(pids.length === 1) {
                    const p = {id:pids[0], ...getNodeDims(pids[0])};
                    drawCurve(p.x + p.w/2, p.y + p.h, child, false);
                } else {
                    const p1 = {id:pids[0], ...getNodeDims(pids[0])};
                    const p2 = {id:pids[1], ...getNodeDims(pids[1])};
                    const pl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pl.setAttribute('class', 'partner-line');
                    if(isHighlighted(p1.id) || isHighlighted(p2.id)) pl.classList.add('highlighted-conn');
                    const py1 = p1.y + p1.h/2; const py2 = p2.y + p2.h/2;
                    pl.setAttribute('d', `M ${p1.x+p1.w/2} ${py1} L ${p2.x+p2.w/2} ${py2}`);
                    cLayer.appendChild(pl);
                    const cx = (p1.x + p1.w/2 + p2.x + p2.w/2) / 2;
                    const cy = (py1 + py2) / 2;
                    drawCurve(cx, cy, child, true);
                }
            });
        }

        function drawCurve(sx, sy, child, fromCenter) {
            const ex = child.x + child.w/2; const ey = child.y;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'connection-line');
            if(isHighlighted(child.id)) path.classList.add('highlighted-conn');
            const c1y = sy + 50; const c2y = ey - 50;
            path.setAttribute('d', `M ${sx} ${sy} C ${sx} ${c1y}, ${ex} ${c2y}, ${ex} ${ey}`);
            document.getElementById('connections-layer').appendChild(path);
        }

        // --- Helpers ---
        function selectNode(id) { 
            selectedNodeId = id; 
            document.querySelectorAll('.node').forEach(el => el.classList.remove('selected', 'show-relation')); 
            document.getElementById(id).classList.add('selected'); 
            
            // Switch panel if open
            if(document.getElementById('sidePanel').classList.contains('open')) {
                openSidePanel(id);
            }

            calculateRelations(id); 
            renderConnections(); 
        }
        function isHighlighted(id) { return selectedNodeId && id === selectedNodeId; }
        
        function calculateRelations(centerId) {
            const centerNode = nodes.find(n => n.id === centerId);
            nodes.forEach(other => {
                if (other.id === centerId) { setLabel(other.id, "Me"); return; }
                const label = getFancyRelation(centerId, other.id, other.gender);
                setLabel(other.id, label);
            });
        }
        function setLabel(id, text) {
            const el = document.getElementById(id);
            const tag = el.querySelector('.relation-tag');
            if(text) { tag.innerText = text; el.classList.add('show-relation'); }
            else { el.classList.remove('show-relation'); }
        }

        function getAncestors(id) {
            let q = [[id, 0]]; let visited = new Map(); visited.set(id, 0);
            let result = [];
            while(q.length > 0) {
                const [curr, dist] = q.shift();
                if (curr !== id) result.push({id: curr, dist: dist});
                connections.filter(c => c.childId === curr).forEach(c => {
                    if(!visited.has(c.parentId)) { visited.set(c.parentId, dist + 1); q.push([c.parentId, dist + 1]); }
                });
            }
            return result;
        }

        function getFancyRelation(meId, otherId, gender) {
            const myAnc = getAncestors(meId);
            const otherAnc = getAncestors(otherId);
            let lca = null; let minSum = Infinity;
            myAnc.forEach(m => {
                const match = otherAnc.find(o => o.id === m.id);
                if(match) { const sum = m.dist + match.dist; if(sum < minSum) { minSum = sum; lca = { common: m.id, myDist: m.dist, otherDist: match.dist }; } }
            });

            if(!lca) {
                const myKids = connections.filter(c => c.parentId === meId).map(c => c.childId);
                const otherKids = connections.filter(c => c.parentId === otherId).map(c => c.childId);
                if(myKids.some(k => otherKids.includes(k))) return "Partner";
                return "";
            }

            const { myDist, otherDist } = lca;
            const g = gender === 'male';
            if(myDist === 0) {
                if(otherDist === 1) return g ? "Son" : "Daughter";
                if(otherDist === 2) return g ? "Grandson" : "Granddaughter";
                if(otherDist === 3) return g ? "Great-Grandson" : "Great-Granddaughter";
            }
            if(otherDist === 0) {
                if(myDist === 1) return g ? "Father" : "Mother";
                if(myDist === 2) return g ? "Grandfather" : "Grandmother";
                if(myDist === 3) return g ? "Great-Grandfather" : "Great-Grandmother";
            }
            if(myDist === 1 && otherDist === 1) return g ? "Brother" : "Sister";
            if(myDist === 1 && otherDist === 2) return g ? "Nephew" : "Niece";
            if(myDist === 2 && otherDist === 1) return g ? "Uncle" : "Aunt";
            if(myDist === 2 && otherDist === 2) return "1st Cousin";
            if(myDist === 3 && otherDist === 3) return "2nd Cousin";
            return "";
        }

        function editName(id) {
            const node = nodes.find(n => n.id === id);
            const nameEl = document.getElementById(id).querySelector('.node-name');
            nameEl.style.display = 'none';
            const input = document.createElement('input'); input.value = node.name;
            document.getElementById(id).appendChild(input); input.focus(); input.select();
            input.onblur = () => { node.name = input.value.trim() || "Name"; nameEl.innerText = node.name; nameEl.style.display = 'block'; input.remove(); autoSave(); if(currentPanelId === id) document.getElementById('panelName').innerText = node.name; };
            input.onkeydown = (e) => { if(e.key === 'Enter') input.blur(); };
        }
        function handleEnter(e) { if(e.key === 'Enter') createNewProject(); }
        function startSpawnDrag(e, type) { e.dataTransfer.effectAllowed = "copy"; e.dataTransfer.setData("type", type); }
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            const type = e.dataTransfer.getData("type");
            if(type) {
                const rect = container.getBoundingClientRect();
                const x = (e.clientX - rect.left - pan.x)/zoom;
                const y = (e.clientY - rect.top - pan.y)/zoom;
                createNode(x, y, type);
            }
        });
        function getNodeDims(id) { const el = document.getElementById(id); if (!el) return { x:0, y:0, w:140, h:60 }; return { x: el.offsetLeft, y: el.offsetTop, w: el.offsetWidth, h: el.offsetHeight }; }

        // --- Start ---
        initLanding();
    </script>
</body>
</html>
